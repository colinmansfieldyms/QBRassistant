<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>YMS QBR Assistant</title>
  <link rel="stylesheet" href="./styles.css" />
  <meta name="theme-color" content="#262262" />
</head>

<body>
  <header class="app-header">
    <div class="brand">
      <div class="brand-mark" aria-hidden="true"></div>
      <div>
        <div class="brand-title">YMS QBR Assistant</div>
        <div class="brand-subtitle">v2025.12.24.0</div>
      </div>
    </div>

    <div class="header-actions">
      <div class="export-dropdown" id="exportDropdown">
        <button class="btn btn-ghost export-dropdown-trigger" type="button" id="exportDropdownTrigger" disabled>
          Exports ▾
        </button>
        <div class="export-dropdown-menu" id="exportDropdownMenu">
          <button id="downloadSummaryBtn" class="export-dropdown-item" type="button">Download Summary TXT</button>
          <button id="printBtn" class="export-dropdown-item" type="button">Print to PDF</button>
        </div>
      </div>

      <label class="toggle">
        <input id="mockModeToggle" type="checkbox" />
        <span>Mock mode</span>
      </label>

      <button id="resetAllBtn" class="btn btn-ghost" type="button" title="Clear inputs/results and wipe token from memory">
        Reset all
      </button>
    </div>
  </header>

  <main class="layout">
    <!-- LEFT COLUMN -->
    <aside class="left">
      <section class="card">
        <div class="card-title">Inputs</div>

        <!-- Data Source Tab Bar -->
        <div class="data-source-tabs">
          <button class="data-source-tab active" data-source="csv" type="button">
            <span class="tab-icon">&#128196;</span>
            <span>CSV</span>
          </button>
          <button class="data-source-tab" data-source="api" type="button">
            <span class="tab-icon">&#128268;</span>
            <span>API</span>
          </button>
        </div>

        <div class="form-grid">
          <label class="field">
            <span>Client subdomain (tenant)</span>
            <input id="tenantInput" type="text" placeholder="e.g., acme" autocomplete="off" spellcheck="false" />
            <small>Base URL: <code>https://{client}.api.ymshub.com/api/v2</code></small>
          </label>

          <!-- API Mode Fields (hidden by default) -->
          <div id="apiModeFields" class="hidden">
            <label class="field">
              <span>API token (in-memory only)</span>
              <div class="row gap-sm">
                <input id="tokenInput" type="password" placeholder="Paste token…" autocomplete="off" spellcheck="false" />
                <button id="clearTokenBtn" class="btn btn-warn" type="button">Clear token now</button>
              </div>
              <small class="warn">
                Token is never persisted (no storage/cookies/URL). Network tools may still show auth headers during live requests.
              </small>
            </label>
          </div>

          <!-- CSV Mode Fields (shown by default) -->
          <div id="csvModeFields">
            <div class="csv-upload-zone" id="csvDropZone">
              <div class="csv-upload-icon">&#128193;</div>
              <div class="csv-upload-text">
                <strong>Drop CSV files here</strong>
                <span>or click to browse</span>
              </div>
              <input type="file" id="csvFileInput" accept=".csv,text/csv" multiple class="csv-file-input" />
            </div>

            <div id="csvFileList" class="csv-file-list-container">
              <!-- File list rendered here -->
            </div>

            <div id="csvValidationMessages" class="csv-validation-messages hidden">
              <!-- Validation messages rendered here -->
            </div>
          </div>

          <label class="field">
            <span>Facility codes (one per line)</span>
            <textarea id="facilitiesInput" rows="5" placeholder="FAC1&#10;FAC2"></textarea>
          </label>

          <!-- Date Range (API mode only) -->
          <div id="dateRangeFields" class="row gap-md">
            <label class="field grow">
              <span>Start date</span>
              <input id="startDateInput" type="date" />
            </label>
            <label class="field grow">
              <span>End date</span>
              <input id="endDateInput" type="date" />
            </label>
          </div>

          <label class="field">
            <span>Timezone</span>
            <select id="timezoneSelect"></select>
            <small>Used for grouping/labels. Most API timestamps assumed UTC unless noted.</small>
          </label>

          <fieldset id="reportsFieldset" class="fieldset">
            <legend>Reports</legend>
            <div class="checks">
              <label><input type="checkbox" class="reportCheck" value="current_inventory" checked /> current_inventory</label>
              <label><input type="checkbox" class="reportCheck" value="detention_history" checked /> detention_history</label>
              <label><input type="checkbox" class="reportCheck" value="dockdoor_history" checked /> dockdoor_history</label>
              <label><input type="checkbox" class="reportCheck" value="driver_history" checked /> driver_history</label>
              <label><input type="checkbox" class="reportCheck" value="trailer_history" checked /> trailer_history</label>
            </div>
          </fieldset>

          <fieldset class="fieldset">
            <legend>ROI assumptions (optional)</legend>
            <div class="roi-categories">

              <!-- Detention Category -->
              <details class="roi-category" id="roiDetention" data-reports="detention_history">
                <summary class="roi-category-toggle">
                  <span class="roi-category-title">Detention</span>
                  <span class="roi-recommended-badge hidden" data-tooltip="">&#9733; Recommended</span>
                  <span class="roi-category-chevron"></span>
                </summary>
                <div class="roi-category-content">
                  <label class="field">
                    <span>Detention cost per hour</span>
                    <input id="assumptionDetention" type="number" min="0" step="0.01" placeholder="e.g., 75" />
                  </label>
                </div>
              </details>

              <!-- Driver Performance Category -->
              <details class="roi-category" id="roiDriver" data-reports="driver_history">
                <summary class="roi-category-toggle">
                  <span class="roi-category-title">Driver Performance</span>
                  <span class="roi-recommended-badge hidden" data-tooltip="">&#9733; Recommended</span>
                  <span class="roi-category-chevron"></span>
                </summary>
                <div class="roi-category-content">
                  <label class="field">
                    <span>Labor fully loaded rate per hour</span>
                    <input id="assumptionLabor" type="number" min="0" step="0.01" placeholder="e.g., 42" />
                  </label>
                  <label class="field">
                    <span>Target moves per driver per day</span>
                    <input id="assumptionTargetMoves" type="number" min="0" step="1" placeholder="50" />
                    <small>Default 50. Top performers can hit 80–100.</small>
                  </label>
                </div>
              </details>

              <!-- Dock Door Utilization Category -->
              <details class="roi-category" id="roiDockDoor" data-reports="dockdoor_history">
                <summary class="roi-category-toggle">
                  <span class="roi-category-title">Dock Door Utilization</span>
                  <span class="roi-recommended-badge hidden" data-tooltip="">&#9733; Recommended</span>
                  <span class="roi-category-chevron"></span>
                </summary>
                <div class="roi-category-content">
                  <label class="field">
                    <span>Target turns per dock door per day</span>
                    <input id="assumptionTargetTurnsPerDoor" type="number" min="0" step="1" placeholder="e.g., 8" />
                    <small>How many trailer turns expected per dock door daily.</small>
                  </label>
                  <label class="field">
                    <span>Cost per dock door hour</span>
                    <input id="assumptionCostPerDockHour" type="number" min="0" step="0.01" placeholder="e.g., 50" />
                    <small>Operational cost per dock door per hour.</small>
                  </label>
                </div>
              </details>

            </div>
            <button id="recalcRoiBtn" class="btn btn-ghost small" type="button" disabled style="margin-top: 8px; font-size: 0.8rem; padding: 4px 10px;">
              ♻️ ROI
            </button>
          </fieldset>
        </div>

        <div class="row gap-md">
          <button id="runBtn" class="btn btn-primary" type="button">Run assessment</button>
          <button id="cancelBtn" class="btn btn-ghost" type="button" disabled>Cancel run</button>
        </div>

        <div id="inputErrors" class="callout callout-error hidden" role="alert"></div>
      </section>

      <section class="card">
        <div class="card-title">Progress</div>
        <div id="progressPanel" class="progress-panel">
          <div class="muted">No run yet.</div>
        </div>
      </section>

      <section class="card hidden" id="perfCard" aria-live="polite">
        <div class="card-title">Performance (debug)</div>
        <div id="perfPanel" class="perf-panel muted small">Perf debug ready. Will populate when a run starts.</div>
      </section>

      <details class="card warnings-card" id="warningsSection">
        <summary class="card-title warnings-toggle">
          <span>Warnings</span>
          <span class="warnings-badge hidden" id="warningsBadge">0</span>
          <span class="warnings-chevron"></span>
        </summary>
        <div id="warningsPanel" class="warnings-panel muted">None.</div>
      </details>
    </aside>

    <!-- RIGHT COLUMN -->
    <section class="right">
      <section id="statusBanner" class="callout hidden" role="status"></section>

      <section id="resultsRoot" class="results">
        <div class="empty-state">
          <div class="empty-title">Ready when you are.</div>
          <div class="empty-subtitle" id="emptyStateSubtitle">
            Paste a token, pick facilities + reports, then run. This app streams aggregation and discards raw rows by default.
          </div>
          <a href="https://github.com/colinmansfieldyms/QBRassistant/blob/main/README.md" target="_blank" rel="noopener" class="btn btn-ghost empty-state-help">How to use</a>
        </div>
      </section>
    </section>

    <!-- ADVANCED SETTINGS DRAWER -->
    <aside id="backpressureDrawer" class="bp-drawer">
      <div class="bp-drawer-header">
        <span class="bp-drawer-title">Advanced Settings</span>
        <button id="bpDrawerClose" class="btn btn-ghost bp-drawer-close" type="button" title="Close drawer">&times;</button>
      </div>

      <div class="bp-drawer-content">
        <div class="bp-drawer-actions">
          <button id="bpResetAll" class="btn btn-warn bp-reset-btn" type="button" title="Reset all settings to system defaults">
            Reset to Defaults
          </button>
          <span id="bpOverrideIndicator" class="bp-override-indicator hidden">Modified</span>
        </div>

        <!-- DATA HANDLING SECTION (open by default) -->
        <details class="bp-section" open>
          <summary class="bp-section-toggle">
            <span>Data Handling</span>
            <span class="bp-section-chevron"></span>
          </summary>
          <div class="bp-section-content">
            <!-- Partial Period Handling -->
            <div class="bp-control">
              <div class="bp-control-header">
                <label class="bp-label">Partial Period Handling</label>
                <span class="bp-scope-badge bp-scope-badge-centered">CHARTS</span>
                <span class="bp-tooltip bp-tooltip-left" data-tooltip="Control how incomplete first/last time periods (e.g., partial weeks at the start or end of your data range) are displayed in line charts. Does not affect metrics or ROI calculations.">?</span>
              </div>
              <div class="bp-radio-group" id="partialPeriodMode">
                <label class="bp-radio-label">
                  <input type="radio" name="partialPeriodMode" value="include" class="bp-radio" checked />
                  <span class="bp-radio-text">
                    <span class="bp-radio-title">Include all data</span>
                    <span class="bp-radio-desc">Show all data points including partial periods</span>
                  </span>
                </label>
                <label class="bp-radio-label">
                  <input type="radio" name="partialPeriodMode" value="trim" class="bp-radio" />
                  <span class="bp-radio-text">
                    <span class="bp-radio-title">Trim partial <span id="partialTrimGranularity">periods</span></span>
                    <span class="bp-radio-desc">Remove incomplete first/last <span class="partial-granularity-label">periods</span> from charts</span>
                  </span>
                </label>
                <label class="bp-radio-label">
                  <input type="radio" name="partialPeriodMode" value="highlight" class="bp-radio" />
                  <span class="bp-radio-text">
                    <span class="bp-radio-title">Highlight partial <span class="partial-granularity-label">periods</span></span>
                    <span class="bp-radio-desc">Show all data with partial <span class="partial-granularity-label">periods</span> visually differentiated</span>
                  </span>
                </label>
              </div>
              <div id="partialPeriodInfo" class="bp-info-box hidden">
                <span class="bp-info-icon">i</span>
                <span id="partialPeriodInfoText">Partial periods detected: none</span>
              </div>
            </div>

            <!-- Drill-Down -->
            <div class="bp-control">
              <div class="bp-control-header">
                <label class="bp-label">Drill-Down</label>
                <span class="bp-tooltip bp-tooltip-left" data-tooltip="Click chart elements to view underlying records. Shows trailer details for selected bars, pie segments, or outlier points.">?</span>
              </div>
              <label class="bp-toggle-label">
                <input type="checkbox" id="drilldownToggle" class="bp-checkbox" checked />
                <span class="bp-toggle-text">Enable</span>
              </label>
            </div>
          </div>
        </details>

        <!-- WEB WORKER SECTION (open by default) -->
        <details class="bp-section" open>
          <summary class="bp-section-toggle">
            <span>Web Worker</span>
            <span class="bp-section-chevron"></span>
          </summary>
          <div class="bp-section-content">
            <div class="bp-control">
              <div class="bp-control-header">
                <label class="bp-label">Processing Mode</label>
                <span class="bp-tooltip bp-tooltip-left" data-tooltip="Web Workers process data in a background thread, keeping the UI responsive during heavy aggregation. Recommended for large datasets.">?</span>
              </div>
              <div class="row gap-md" style="align-items: center;">
                <label class="toggle">
                  <input id="workerToggle" type="checkbox" checked />
                  <span>Enable Web Worker (recommended)</span>
                </label>
              </div>
              <div id="workerStatus" class="muted small" style="margin-top: 8px;">Initializing…</div>
            </div>
          </div>
        </details>

        <!-- API BACKPRESSURE OVERRIDES (collapsed by default) -->
        <details class="bp-section">
          <summary class="bp-section-toggle">
            <span>API Backpressure Overrides</span>
            <span class="bp-section-chevron"></span>
          </summary>
          <div class="bp-section-content">
            <!-- PRESETS (collapsed by default) -->
            <details class="bp-presets-section">
              <summary class="bp-presets-toggle">
                <span>Testing Presets</span>
                <span class="bp-presets-chevron"></span>
              </summary>
              <div class="bp-presets-content">
                <table class="bp-presets-table">
                  <thead>
                    <tr>
                      <th>Preset</th>
                      <th>Description</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody id="bpPresetsBody">
                    <!-- Populated by JS -->
                  </tbody>
                </table>
              </div>
            </details>

            <!-- CONCURRENCY GROUP -->
            <div class="bp-group">
              <div class="bp-group-title">Concurrency</div>

          <div class="bp-control">
            <div class="bp-control-header">
              <label for="bpGlobalMaxConcurrency" class="bp-label">Global Max Concurrency</label>
              <span class="bp-tooltip bp-tooltip-left" data-tooltip="Maximum simultaneous API requests across all reports. Higher values fetch data faster but may overwhelm the server or browser.">?</span>
            </div>
            <div class="bp-control-row">
              <input type="range" id="bpGlobalMaxConcurrency" class="bp-slider" min="1" max="20" step="1" />
              <span class="bp-value" data-for="bpGlobalMaxConcurrency">8</span>
              <span class="bp-unit">requests</span>
            </div>
            <div class="bp-default" data-default-for="bpGlobalMaxConcurrency">Default: 8</div>
          </div>
        </div>

        <!-- GREEN ZONE GROUP -->
        <div class="bp-group">
          <div class="bp-group-title">Green Zone</div>

          <div class="bp-control">
            <div class="bp-control-header">
              <label class="bp-label">Enable Green Zone</label>
              <span class="bp-tooltip bp-tooltip-left" data-tooltip="When enabled, the system automatically boosts concurrency when all reports are responding quickly and memory is healthy.">?</span>
            </div>
            <label class="bp-toggle-label">
              <input type="checkbox" id="bpGreenZoneEnabled" class="bp-checkbox" checked />
              <span class="bp-toggle-text">Enabled</span>
            </label>
            <div class="bp-default">Default: Enabled</div>
          </div>

          <div class="bp-control bp-control-dependent" data-depends-on="bpGreenZoneEnabled">
            <div class="bp-control-header">
              <label for="bpGreenZoneConcurrencyMax" class="bp-label">Green Zone Boost Level</label>
              <span class="bp-tooltip bp-tooltip-left" data-tooltip="Maximum concurrency allowed when Green Zone is active. Only takes effect when Green Zone is enabled and conditions are favorable.">?</span>
            </div>
            <div class="bp-control-row">
              <input type="range" id="bpGreenZoneConcurrencyMax" class="bp-slider" min="8" max="20" step="1" />
              <span class="bp-value" data-for="bpGreenZoneConcurrencyMax">12</span>
              <span class="bp-unit">requests</span>
            </div>
            <div class="bp-default" data-default-for="bpGreenZoneConcurrencyMax">Default: 12</div>
          </div>

          <div class="bp-control bp-control-dependent" data-depends-on="bpGreenZoneEnabled">
            <div class="bp-control-header">
              <label for="bpGreenZoneStreakCount" class="bp-label">Entry Streak Count</label>
              <span class="bp-tooltip bp-tooltip-left" data-tooltip="Number of consecutive 'good' latency samples required before entering Green Zone. Lower = more aggressive boosting, higher = more conservative.">?</span>
            </div>
            <div class="bp-control-row">
              <input type="range" id="bpGreenZoneStreakCount" class="bp-slider" min="1" max="10" step="1" />
              <span class="bp-value" data-for="bpGreenZoneStreakCount">4</span>
              <span class="bp-unit">samples</span>
            </div>
            <div class="bp-default" data-default-for="bpGreenZoneStreakCount">Default: 4</div>
          </div>
        </div>

        <!-- PIPELINE GROUP -->
        <div class="bp-group">
          <div class="bp-group-title">Pipeline</div>

          <div class="bp-control">
            <div class="bp-control-header">
              <label for="bpFetchBufferSize" class="bp-label">Fetch Buffer Size</label>
              <span class="bp-tooltip bp-tooltip-left" data-tooltip="Maximum pages to download ahead of processing. Larger buffers keep workers busy but use more memory.">?</span>
            </div>
            <div class="bp-control-row">
              <input type="range" id="bpFetchBufferSize" class="bp-slider" min="2" max="20" step="1" />
              <span class="bp-value" data-for="bpFetchBufferSize">9</span>
              <span class="bp-unit">pages</span>
            </div>
            <div class="bp-default" data-default-for="bpFetchBufferSize">Default: 9</div>
          </div>

          <div class="bp-control">
            <div class="bp-control-header">
              <label for="bpProcessingPoolSize" class="bp-label">Processing Pool Size</label>
              <span class="bp-tooltip bp-tooltip-left" data-tooltip="Number of pages to process simultaneously. Higher values increase CPU usage but can speed up analysis.">?</span>
            </div>
            <div class="bp-control-row">
              <input type="range" id="bpProcessingPoolSize" class="bp-slider" min="1" max="6" step="1" />
              <span class="bp-value" data-for="bpProcessingPoolSize">3</span>
              <span class="bp-unit">tasks</span>
            </div>
            <div class="bp-default" data-default-for="bpProcessingPoolSize">Default: 3</div>
          </div>

          <div class="bp-control">
            <div class="bp-control-header">
              <label for="bpPageQueueLimit" class="bp-label">Page Queue Limit</label>
              <span class="bp-tooltip bp-tooltip-left" data-tooltip="Maximum pages waiting in the prefetch queue. Acts as a memory safety valve.">?</span>
            </div>
            <div class="bp-control-row">
              <input type="range" id="bpPageQueueLimit" class="bp-slider" min="5" max="30" step="1" />
              <span class="bp-value" data-for="bpPageQueueLimit">10</span>
              <span class="bp-unit">pages</span>
            </div>
            <div class="bp-default" data-default-for="bpPageQueueLimit">Default: 10</div>
          </div>

          <div class="bp-control">
            <div class="bp-control-header">
              <label for="bpForceTier" class="bp-label">Force Tier</label>
              <span class="bp-tooltip bp-tooltip-left" data-tooltip="Override automatic dataset size detection. Use 'Auto' for normal operation, or force a specific tier to test behavior.">?</span>
            </div>
            <select id="bpForceTier" class="bp-select">
              <option value="auto">Auto (detect from data)</option>
              <option value="tiny">Tiny (&lt;50 pages)</option>
              <option value="small">Small (&lt;200 pages)</option>
              <option value="medium">Medium (&lt;500 pages)</option>
              <option value="large">Large (&lt;1000 pages)</option>
              <option value="huge">Huge (1000+ pages)</option>
            </select>
            <div class="bp-default">Default: Auto</div>
          </div>
        </div>

        <!-- WORKER GROUP -->
        <div class="bp-group">
          <div class="bp-group-title">Worker</div>

          <div class="bp-control">
            <div class="bp-control-header">
              <label for="bpBatchSize" class="bp-label">Batch Size</label>
              <span class="bp-tooltip bp-tooltip-left" data-tooltip="Number of rows sent to the Web Worker at once. Larger batches reduce transfer overhead but increase memory spikes.">?</span>
            </div>
            <div class="bp-control-row">
              <input type="range" id="bpBatchSize" class="bp-slider" min="100" max="2000" step="50" />
              <span class="bp-value" data-for="bpBatchSize">600</span>
              <span class="bp-unit">rows</span>
            </div>
            <div class="bp-default" data-default-for="bpBatchSize">Default: 600</div>
          </div>

          <div class="bp-control">
            <div class="bp-control-header">
              <label for="bpPartialUpdateInterval" class="bp-label">Partial Update Interval</label>
              <span class="bp-tooltip bp-tooltip-left" data-tooltip="How often the UI receives progress updates during processing. Faster updates feel more responsive but add overhead.">?</span>
            </div>
            <div class="bp-control-row">
              <input type="range" id="bpPartialUpdateInterval" class="bp-slider" min="200" max="5000" step="100" />
              <span class="bp-value" data-for="bpPartialUpdateInterval">1000</span>
              <span class="bp-unit">ms</span>
            </div>
            <div class="bp-default" data-default-for="bpPartialUpdateInterval">Default: 1000</div>
          </div>
        </div>
          </div><!-- /.bp-section-content -->
        </details><!-- /.bp-section API Backpressure Overrides -->

        <!-- DEBUG MODE SECTION (collapsed by default) -->
        <details class="bp-section">
          <summary class="bp-section-toggle">
            <span>Debug Mode</span>
            <span class="bp-section-chevron"></span>
          </summary>
          <div class="bp-section-content">
            <div class="bp-control">
              <div class="bp-control-header" style="margin-bottom: 12px;">
                <a href="https://colinmansfieldyms.github.io/QBRassistant/?perf=1" target="_blank" rel="noopener" class="btn btn-ghost">
                  Launch Debug Mode
                </a>
                <span class="bp-tooltip bp-tooltip-left" data-tooltip="Opens the app with performance instrumentation enabled. Shows real-time metrics including request latency, pages/second, memory usage, and processing times. No tokens or PII are logged.">?</span>
              </div>
            </div>
          </div>
        </details>
      </div>
    </aside>

    <!-- DRAWER TOGGLE BUTTON -->
    <button id="bpDrawerToggle" class="bp-drawer-toggle" type="button" title="Open Advanced Settings">
      <span class="bp-drawer-toggle-icon"></span>
      <span class="bp-drawer-toggle-label">Advanced</span>
    </button>
  </main>

  <!-- CDNs (no build step) -->
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.5.0/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- App -->
  <script type="module" src="./app.js?v=2025.01.07.0"></script>
</body>
</html>
